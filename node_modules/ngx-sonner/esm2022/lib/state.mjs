import { signal } from '@angular/core';
let toastsCounter = 0;
function createToastState() {
    const toasts = signal([]);
    const heights = signal([]);
    function addToast(data) {
        toasts.update(prev => [data, ...prev]);
    }
    function create(data) {
        const { message, ...rest } = data;
        const id = typeof data?.id === 'number' || (data.id && data.id?.length > 0)
            ? data.id
            : toastsCounter++;
        const dismissible = data.dismissible ?? true;
        const type = data.type ?? 'default';
        const alreadyExists = toasts().find(toast => toast.id === id);
        if (alreadyExists) {
            toasts.update(prev => prev.map(toast => {
                if (toast.id === id) {
                    return {
                        ...toast,
                        ...data,
                        id,
                        title: message,
                        dismissible,
                        type,
                        updated: true,
                    };
                }
                else
                    return { ...toast, updated: false };
            }));
        }
        else {
            addToast({ ...rest, id, title: message, dismissible: dismissible, type });
        }
        return id;
    }
    function dismiss(id) {
        if (id === undefined) {
            toasts.set([]);
            return;
        }
        toasts.update(prev => prev.filter(toast => toast.id !== id));
        return id;
    }
    function message(message, data) {
        return create({ ...data, type: 'default', message });
    }
    function error(message, data) {
        return create({ ...data, type: 'error', message });
    }
    function success(message, data) {
        return create({ ...data, type: 'success', message });
    }
    function info(message, data) {
        return create({ ...data, type: 'info', message });
    }
    function warning(message, data) {
        return create({ ...data, type: 'warning', message });
    }
    function loading(message, data) {
        return create({ ...data, type: 'loading', message });
    }
    function promise(promise, data) {
        if (!data)
            return;
        let id = undefined;
        if (data.loading !== undefined) {
            id = create({
                ...data,
                promise,
                type: 'loading',
                message: data.loading,
            });
        }
        const p = promise instanceof Promise ? promise : promise();
        let shouldDismiss = id !== undefined;
        p.then(response => {
            // @ts-expect-error: Incorrect response type
            if (response && typeof response.ok === 'boolean' && !response.ok) {
                shouldDismiss = false;
                const message = typeof data.error === 'function'
                    ? // @ts-expect-error: TODO: Better function checking
                        data.error(`HTTP error! status: ${response.status}`)
                    : data.error;
                create({ id, type: 'error', message });
            }
            else if (data.success !== undefined) {
                shouldDismiss = false;
                const message = typeof data.success === 'function'
                    ? // @ts-expect-error: TODO: Better function checking
                        data.success(response)
                    : data.success;
                create({ id, type: 'success', message });
            }
        })
            .catch(error => {
            if (data.error !== undefined) {
                shouldDismiss = false;
                const message = 
                // @ts-expect-error: TODO: Better function checking
                typeof data.error === 'function' ? data.error(error) : data.error;
                create({ id, type: 'error', message });
            }
        })
            .finally(() => {
            if (shouldDismiss) {
                // Toast is still in load state (and will be indefinitely â€” dismiss it)
                dismiss(id);
                id = undefined;
            }
            data.finally?.();
        });
        return id;
    }
    function custom(component, data) {
        const id = data?.id ?? toastsCounter++;
        create({ component, id, ...data });
        return id;
    }
    function removeHeight(id) {
        heights.update(prev => prev.filter(height => height.toastId !== id));
    }
    function addHeight(height) {
        heights.update(prev => [height, ...prev].sort(sortHeights));
    }
    const sortHeights = (a, b) => toasts().findIndex(t => t.id === a.toastId) -
        toasts().findIndex(t => t.id === b.toastId);
    function reset() {
        toasts.set([]);
        heights.set([]);
    }
    return {
        //methods
        create,
        addToast,
        dismiss,
        message,
        error,
        success,
        info,
        warning,
        loading,
        promise,
        custom,
        removeHeight,
        addHeight,
        reset,
        // signals
        toasts: toasts.asReadonly(),
        heights: heights.asReadonly(),
    };
}
export const toastState = createToastState();
// bind this to the toast function
function toastFunction(message, data) {
    return toastState.create({
        message,
        ...data,
    });
}
const basicToast = toastFunction;
export const toast = Object.assign(basicToast, {
    success: toastState.success,
    info: toastState.info,
    warning: toastState.warning,
    error: toastState.error,
    custom: toastState.custom,
    message: toastState.message,
    promise: toastState.promise,
    dismiss: toastState.dismiss,
    loading: toastState.loading,
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3RhdGUuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi9saWJzL25neC1zb25uZXIvc3JjL2xpYi9zdGF0ZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsTUFBTSxFQUFRLE1BQU0sZUFBZSxDQUFDO0FBVTdDLElBQUksYUFBYSxHQUFHLENBQUMsQ0FBQztBQUV0QixTQUFTLGdCQUFnQjtJQUN2QixNQUFNLE1BQU0sR0FBRyxNQUFNLENBQVcsRUFBRSxDQUFDLENBQUM7SUFDcEMsTUFBTSxPQUFPLEdBQUcsTUFBTSxDQUFZLEVBQUUsQ0FBQyxDQUFDO0lBRXRDLFNBQVMsUUFBUSxDQUFDLElBQVk7UUFDNUIsTUFBTSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLENBQUMsSUFBSSxFQUFFLEdBQUcsSUFBSSxDQUFDLENBQUMsQ0FBQztJQUN6QyxDQUFDO0lBRUQsU0FBUyxNQUFNLENBQ2IsSUFJQztRQUVELE1BQU0sRUFBRSxPQUFPLEVBQUUsR0FBRyxJQUFJLEVBQUUsR0FBRyxJQUFJLENBQUM7UUFDbEMsTUFBTSxFQUFFLEdBQ04sT0FBTyxJQUFJLEVBQUUsRUFBRSxLQUFLLFFBQVEsSUFBSSxDQUFDLElBQUksQ0FBQyxFQUFFLElBQUksSUFBSSxDQUFDLEVBQUUsRUFBRSxNQUFNLEdBQUcsQ0FBQyxDQUFDO1lBQzlELENBQUMsQ0FBQyxJQUFJLENBQUMsRUFBRTtZQUNULENBQUMsQ0FBQyxhQUFhLEVBQUUsQ0FBQztRQUV0QixNQUFNLFdBQVcsR0FBRyxJQUFJLENBQUMsV0FBVyxJQUFJLElBQUksQ0FBQztRQUM3QyxNQUFNLElBQUksR0FBRyxJQUFJLENBQUMsSUFBSSxJQUFJLFNBQVMsQ0FBQztRQUVwQyxNQUFNLGFBQWEsR0FBRyxNQUFNLEVBQUUsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLEVBQUUsQ0FBQyxLQUFLLENBQUMsRUFBRSxLQUFLLEVBQUUsQ0FBQyxDQUFD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QStCLEVBQUUsSUFBb0I7SUFDMUUsT0FBTyxVQUFVLENBQUMsTUFBTSxDQUFDO1FBQ3ZCLE9BQU87UUFDUCxHQUFHLElBQUk7S0FDUixDQUFDLENBQUM7QUFDTCxDQUFDO0FBRUQsTUFBTSxVQUFVLEdBQUcsYUFBYSxDQUFDO0FBRWpDLE1BQU0sQ0FBQyxNQUFNLEtBQUssR0FBRyxNQUFNLENBQUMsTUFBTSxDQUFDLFVBQVUsRUFBRTtJQUM3QyxPQUFPLEVBQUUsVUFBVSxDQUFDLE9BQU87SUFDM0IsSUFBSSxFQUFFLFVBQVUsQ0FBQyxJQUFJO0lBQ3JCLE9BQU8sRUFBRSxVQUFVLENBQUMsT0FBTztJQUMzQixLQUFLLEVBQUUsVUFBVSxDQUFDLEtBQUs7SUFDdkIsTUFBTSxFQUFFLFVBQVUsQ0FBQyxNQUFNO0lBQ3pCLE9BQU8sRUFBRSxVQUFVLENBQUMsT0FBTztJQUMzQixPQUFPLEVBQUUsVUFBVSxDQUFDLE9BQU87SUFDM0IsT0FBTyxFQUFFLFVBQVUsQ0FBQyxPQUFPO0lBQzNCLE9BQU8sRUFBRSxVQUFVLENBQUMsT0FBTztDQUM1QixDQUFDLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBzaWduYWwsIFR5cGUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7XG4gIEV4dGVybmFsVG9hc3QsXG4gIEhlaWdodFQsXG4gIFByb21pc2VEYXRhLFxuICBQcm9taXNlVCxcbiAgVG9hc3RULFxuICBUb2FzdFR5cGVzLFxufSBmcm9tICcuL3R5cGVzJztcblxubGV0IHRvYXN0c0NvdW50ZXIgPSAwO1xuXG5mdW5jdGlvbiBjcmVhdGVUb2FzdFN0YXRlKCkge1xuICBjb25zdCB0b2FzdHMgPSBzaWduYWw8VG9hc3RUW10+KFtdKTtcbiAgY29uc3QgaGVpZ2h0cyA9IHNpZ25hbDxIZWlnaHRUW10+KFtdKTtcblxuICBmdW5jdGlvbiBhZGRUb2FzdChkYXRhOiBUb2FzdFQpIHtcbiAgICB0b2FzdHMudXBkYXRlKHByZXYgPT4gW2RhdGEsIC4uLnByZXZdKTtcbiAgfVxuXG4gIGZ1bmN0aW9uIGNyZWF0ZShcbiAgICBkYXRhOiBFeHRlcm5hbFRvYXN0ICYge1xuICAgICAgbWVzc2FnZT86IHN0cmluZyB8IFR5cGU8dW5rbm93bj47XG4gICAgICB0eXBlPzogVG9hc3RUeXBlcztcbiAgICAgIHByb21pc2U/OiBQcm9taXNlVDtcbiAgICB9XG4gICkge1xuICAgIGNvbnN0IHsgbWVzc2FnZSwgLi4ucmVzdCB9ID0gZGF0YTtcbiAgICBjb25zdCBpZCA9XG4gICAgICB0eXBlb2YgZGF0YT8uaWQgPT09ICdudW1iZXInIHx8IChkYXRhLmlkICYmIGRhdGEuaWQ/Lmxlbmd0aCA+IDApXG4gICAgICAgID8gZGF0YS5pZFxuICAgICAgICA6IHRvYXN0c0NvdW50ZXIrKztcblxuICAgIGNvbnN0IGRpc21pc3NpYmxlID0gZGF0YS5kaXNtaXNzaWJsZSA/PyB0cnVlO1xuICAgIGNvbnN0IHR5cGUgPSBkYXRhLnR5cGUgPz8gJ2RlZmF1bHQnO1xuXG4gICAgY29uc3QgYWxyZWFkeUV4aXN0cyA9IHRvYXN0cygpLmZpbmQodG9hc3QgPT4gdG9hc3QuaWQgPT09IGlkKTtcblxuICAgIGlmIChhbHJlYWR5RXhpc3RzKSB7XG4gICAgICB0b2FzdHMudXBkYXRlKHByZXYgPT5cbiAgICAgICAgcHJldi5tYXAodG9hc3QgPT4ge1xuICAgICAgICAgIGlmICh0b2FzdC5pZCA9PT0gaWQpIHtcbiAgICAgICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICAgIC4uLnRvYXN0LFxuICAgICAgICAgICAgICAuLi5kYXRhLFxuICAgICAgICAgICAgICBpZCxcbiAgICAgICAgICAgICAgdGl0bGU6IG1lc3NhZ2UsXG4gICAgICAgICAgICAgIGRpc21pc3NpYmxlLFxuICAgICAgICAgICAgICB0eXBlLFxuICAgICAgICAgICAgICB1cGRhdGVkOiB0cnVlLFxuICAgICAgICAgICAgfTtcbiAgICAgICAgICB9IGVsc2UgcmV0dXJuIHsgLi4udG9hc3QsIHVwZGF0ZWQ6IGZhbHNlIH07XG4gICAgICAgIH0pXG4gICAgICApO1xuICAgIH0gZWxzZSB7XG4gICAgICBhZGRUb2FzdCh7IC4uLnJlc3QsIGlkLCB0aXRsZTogbWVzc2FnZSwgZGlzbWlzc2libGU6IGRpc21pc3NpYmxlLCB0eXBlIH0pO1xuICAgIH1cblxuICAgIHJldHVybiBpZDtcbiAgfVxuXG4gIGZ1bmN0aW9uIGRpc21pc3MoaWQ/OiBudW1iZXIgfCBzdHJpbmcpIHtcbiAgICBpZiAoaWQgPT09IHVuZGVmaW5lZCkge1xuICAgICAgdG9hc3RzLnNldChbXSk7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIHRvYXN0cy51cGRhdGUocHJldiA9PiBwcmV2LmZpbHRlcih0b2FzdCA9PiB0b2FzdC5pZCAhPT0gaWQpKTtcblxuICAgIHJldHVybiBpZDtcbiAgfVxuXG4gIGZ1bmN0aW9uIG1lc3NhZ2UobWVzc2FnZTogc3RyaW5nIHwgVHlwZTx1bmtub3duPiwgZGF0YT86IEV4dGVybmFsVG9hc3QpIHtcbiAgICByZXR1cm4gY3JlYXRlKHsgLi4uZGF0YSwgdHlwZTogJ2RlZmF1bHQnLCBtZXNzYWdlIH0pO1xuICB9XG5cbiAgZnVuY3Rpb24gZXJyb3IobWVzc2FnZTogc3RyaW5nIHwgVHlwZTx1bmtub3duPiwgZGF0YT86IEV4dGVybmFsVG9hc3QpIHtcbiAgICByZXR1cm4gY3JlYXRlKHsgLi4uZGF0YSwgdHlwZTogJ2Vycm9yJywgbWVzc2FnZSB9KTtcbiAgfVxuXG4gIGZ1bmN0aW9uIHN1Y2Nlc3MobWVzc2FnZTogc3RyaW5nIHwgVHlwZTx1bmtub3duPiwgZGF0YT86IEV4dGVybmFsVG9hc3QpIHtcbiAgICByZXR1cm4gY3JlYXRlKHsgLi4uZGF0YSwgdHlwZTogJ3N1Y2Nlc3MnLCBtZXNzYWdlIH0pO1xuICB9XG5cbiAgZnVuY3Rpb24gaW5mbyhtZXNzYWdlOiBzdHJpbmcgfCBUeXBlPHVua25vd24+LCBkYXRhPzogRXh0ZXJuYWxUb2FzdCkge1xuICAgIHJldHVybiBjcmVhdGUoeyAuLi5kYXRhLCB0eXBlOiAnaW5mbycsIG1lc3NhZ2UgfSk7XG4gIH1cblxuICBmdW5jdGlvbiB3YXJuaW5nKG1lc3NhZ2U6IHN0cmluZyB8IFR5cGU8dW5rbm93bj4sIGRhdGE/OiBFeHRlcm5hbFRvYXN0KSB7XG4gICAgcmV0dXJuIGNyZWF0ZSh7IC4uLmRhdGEsIHR5cGU6ICd3YXJuaW5nJywgbWVzc2FnZSB9KTtcbiAgfVxuXG4gIGZ1bmN0aW9uIGxvYWRpbmcobWVzc2FnZTogc3RyaW5nIHwgVHlwZTx1bmtub3duPiwgZGF0YT86IEV4dGVybmFsVG9hc3QpIHtcbiAgICByZXR1cm4gY3JlYXRlKHsgLi4uZGF0YSwgdHlwZTogJ2xvYWRpbmcnLCBtZXNzYWdlIH0pO1xuICB9XG5cbiAgZnVuY3Rpb24gcHJvbWlzZTxUb2FzdERhdGE+KFxuICAgIHByb21pc2U6IFByb21pc2VUPFRvYXN0RGF0YT4sXG4gICAgZGF0YT86IFByb21pc2VEYXRhPFRvYXN0RGF0YT5cbiAgKSB7XG4gICAgaWYgKCFkYXRhKSByZXR1cm47XG5cbiAgICBsZXQgaWQ6IHN0cmluZyB8IG51bWJlciB8IHVuZGVmaW5lZCA9IHVuZGVmaW5lZDtcbiAgICBpZiAoZGF0YS5sb2FkaW5nICE9PSB1bmRlZmluZWQpIHtcbiAgICAgIGlkID0gY3JlYXRlKHtcbiAgICAgICAgLi4uZGF0YSxcbiAgICAgICAgcHJvbWlzZSxcbiAgICAgICAgdHlwZTogJ2xvYWRpbmcnLFxuICAgICAgICBtZXNzYWdlOiBkYXRhLmxvYWRpbmcsXG4gICAgICB9KTtcbiAgICB9XG5cbiAgICBjb25zdCBwID0gcHJvbWlzZSBpbnN0YW5jZW9mIFByb21pc2UgPyBwcm9taXNlIDogcHJvbWlzZSgpO1xuXG4gICAgbGV0IHNob3VsZERpc21pc3MgPSBpZCAhPT0gdW5kZWZpbmVkO1xuXG4gICAgcC50aGVuKHJlc3BvbnNlID0+IHtcbiAgICAgIC8vIEB0cy1leHBlY3QtZXJyb3I6IEluY29ycmVjdCByZXNwb25zZSB0eXBlXG4gICAgICBpZiAocmVzcG9uc2UgJiYgdHlwZW9mIHJlc3BvbnNlLm9rID09PSAnYm9vbGVhbicgJiYgIXJlc3BvbnNlLm9rKSB7XG4gICAgICAgIHNob3VsZERpc21pc3MgPSBmYWxzZTtcblxuICAgICAgICBjb25zdCBtZXNzYWdlID1cbiAgICAgICAgICB0eXBlb2YgZGF0YS5lcnJvciA9PT0gJ2Z1bmN0aW9uJ1xuICAgICAgICAgICAgPyAvLyBAdHMtZXhwZWN0LWVycm9yOiBUT0RPOiBCZXR0ZXIgZnVuY3Rpb24gY2hlY2tpbmdcbiAgICAgICAgICAgICAgZGF0YS5lcnJvcihgSFRUUCBlcnJvciEgc3RhdHVzOiAke3Jlc3BvbnNlLnN0YXR1c31gKVxuICAgICAgICAgICAgOiBkYXRhLmVycm9yO1xuICAgICAgICBjcmVhdGUoeyBpZCwgdHlwZTogJ2Vycm9yJywgbWVzc2FnZSB9KTtcbiAgICAgIH0gZWxzZSBpZiAoZGF0YS5zdWNjZXNzICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgc2hvdWxkRGlzbWlzcyA9IGZhbHNlO1xuXG4gICAgICAgIGNvbnN0IG1lc3NhZ2UgPVxuICAgICAgICAgIHR5cGVvZiBkYXRhLnN1Y2Nlc3MgPT09ICdmdW5jdGlvbidcbiAgICAgICAgICAgID8gLy8gQHRzLWV4cGVjdC1lcnJvcjogVE9ETzogQmV0dGVyIGZ1bmN0aW9uIGNoZWNraW5nXG4gICAgICAgICAgICAgIGRhdGEuc3VjY2VzcyhyZXNwb25zZSlcbiAgICAgICAgICAgIDogZGF0YS5zdWNjZXNzO1xuICAgICAgICBjcmVhdGUoeyBpZCwgdHlwZTogJ3N1Y2Nlc3MnLCBtZXNzYWdlIH0pO1xuICAgICAgfVxuICAgIH0pXG4gICAgICAuY2F0Y2goZXJyb3IgPT4ge1xuICAgICAgICBpZiAoZGF0YS5lcnJvciAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgc2hvdWxkRGlzbWlzcyA9IGZhbHNlO1xuICAgICAgICAgIGNvbnN0IG1lc3NhZ2UgPVxuICAgICAgICAgICAgLy8gQHRzLWV4cGVjdC1lcnJvcjogVE9ETzogQmV0dGVyIGZ1bmN0aW9uIGNoZWNraW5nXG4gICAgICAgICAgICB0eXBlb2YgZGF0YS5lcnJvciA9PT0gJ2Z1bmN0aW9uJyA/IGRhdGEuZXJyb3IoZXJyb3IpIDogZGF0YS5lcnJvcjtcbiAgICAgICAgICBjcmVhdGUoeyBpZCwgdHlwZTogJ2Vycm9yJywgbWVzc2FnZSB9KTtcbiAgICAgICAgfVxuICAgICAgfSlcbiAgICAgIC5maW5hbGx5KCgpID0+IHtcbiAgICAgICAgaWYgKHNob3VsZERpc21pc3MpIHtcbiAgICAgICAgICAvLyBUb2FzdCBpcyBzdGlsbCBpbiBsb2FkIHN0YXRlIChhbmQgd2lsbCBiZSBpbmRlZmluaXRlbHkg4oCUIGRpc21pc3MgaXQpXG4gICAgICAgICAgZGlzbWlzcyhpZCk7XG4gICAgICAgICAgaWQgPSB1bmRlZmluZWQ7XG4gICAgICAgIH1cblxuICAgICAgICBkYXRhLmZpbmFsbHk/LigpO1xuICAgICAgfSk7XG5cbiAgICByZXR1cm4gaWQ7XG4gIH1cblxuICBmdW5jdGlvbiBjdXN0b208VD4oY29tcG9uZW50OiBUeXBlPFQ+LCBkYXRhPzogRXh0ZXJuYWxUb2FzdCkge1xuICAgIGNvbnN0IGlkID0gZGF0YT8uaWQgPz8gdG9hc3RzQ291bnRlcisrO1xuICAgIGNyZWF0ZSh7IGNvbXBvbmVudCwgaWQsIC4uLmRhdGEgfSk7XG5cbiAgICByZXR1cm4gaWQ7XG4gIH1cblxuICBmdW5jdGlvbiByZW1vdmVIZWlnaHQoaWQ6IG51bWJlciB8IHN0cmluZykge1xuICAgIGhlaWdodHMudXBkYXRlKHByZXYgPT4gcHJldi5maWx0ZXIoaGVpZ2h0ID0+IGhlaWdodC50b2FzdElkICE9PSBpZCkpO1xuICB9XG5cbiAgZnVuY3Rpb24gYWRkSGVpZ2h0KGhlaWdodDogSGVpZ2h0VCkge1xuICAgIGhlaWdodHMudXBkYXRlKHByZXYgPT4gW2hlaWdodCwgLi4ucHJldl0uc29ydChzb3J0SGVpZ2h0cykpO1xuICB9XG5cbiAgY29uc3Qgc29ydEhlaWdodHMgPSAoYTogSGVpZ2h0VCwgYjogSGVpZ2h0VCkgPT5cbiAgICB0b2FzdHMoKS5maW5kSW5kZXgodCA9PiB0LmlkID09PSBhLnRvYXN0SWQpIC1cbiAgICB0b2FzdHMoKS5maW5kSW5kZXgodCA9PiB0LmlkID09PSBiLnRvYXN0SWQpO1xuXG4gIGZ1bmN0aW9uIHJlc2V0KCkge1xuICAgIHRvYXN0cy5zZXQoW10pO1xuICAgIGhlaWdodHMuc2V0KFtdKTtcbiAgfVxuXG4gIHJldHVybiB7XG4gICAgLy9tZXRob2RzXG4gICAgY3JlYXRlLFxuICAgIGFkZFRvYXN0LFxuICAgIGRpc21pc3MsXG4gICAgbWVzc2FnZSxcbiAgICBlcnJvcixcbiAgICBzdWNjZXNzLFxuICAgIGluZm8sXG4gICAgd2FybmluZyxcbiAgICBsb2FkaW5nLFxuICAgIHByb21pc2UsXG4gICAgY3VzdG9tLFxuICAgIHJlbW92ZUhlaWdodCxcbiAgICBhZGRIZWlnaHQsXG4gICAgcmVzZXQsXG4gICAgLy8gc2lnbmFsc1xuICAgIHRvYXN0czogdG9hc3RzLmFzUmVhZG9ubHkoKSxcbiAgICBoZWlnaHRzOiBoZWlnaHRzLmFzUmVhZG9ubHkoKSxcbiAgfTtcbn1cblxuZXhwb3J0IGNvbnN0IHRvYXN0U3RhdGUgPSBjcmVhdGVUb2FzdFN0YXRlKCk7XG5cbi8vIGJpbmQgdGhpcyB0byB0aGUgdG9hc3QgZnVuY3Rpb25cbmZ1bmN0aW9uIHRvYXN0RnVuY3Rpb24obWVzc2FnZTogc3RyaW5nIHwgVHlwZTx1bmtub3duPiwgZGF0YT86IEV4dGVybmFsVG9hc3QpIHtcbiAgcmV0dXJuIHRvYXN0U3RhdGUuY3JlYXRlKHtcbiAgICBtZXNzYWdlLFxuICAgIC4uLmRhdGEsXG4gIH0pO1xufVxuXG5jb25zdCBiYXNpY1RvYXN0ID0gdG9hc3RGdW5jdGlvbjtcblxuZXhwb3J0IGNvbnN0IHRvYXN0ID0gT2JqZWN0LmFzc2lnbihiYXNpY1RvYXN0LCB7XG4gIHN1Y2Nlc3M6IHRvYXN0U3RhdGUuc3VjY2VzcyxcbiAgaW5mbzogdG9hc3RTdGF0ZS5pbmZvLFxuICB3YXJuaW5nOiB0b2FzdFN0YXRlLndhcm5pbmcsXG4gIGVycm9yOiB0b2FzdFN0YXRlLmVycm9yLFxuICBjdXN0b206IHRvYXN0U3RhdGUuY3VzdG9tLFxuICBtZXNzYWdlOiB0b2FzdFN0YXRlLm1lc3NhZ2UsXG4gIHByb21pc2U6IHRvYXN0U3RhdGUucHJvbWlzZSxcbiAgZGlzbWlzczogdG9hc3RTdGF0ZS5kaXNtaXNzLFxuICBsb2FkaW5nOiB0b2FzdFN0YXRlLmxvYWRpbmcsXG59KTtcbiJdfQ==